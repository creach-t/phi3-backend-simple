# üß™ Collection de tests Hoppscotch

Cette collection contient tous les tests pour valider le bon fonctionnement du backend Phi-3 Simple.

## üìã Variables d'environnement

Avant de commencer, configurez ces variables dans Hoppscotch :

| Variable | Valeur | Description |
|----------|--------|-------------|
| `BASE_URL` | `http://localhost:3000` | URL de base du serveur |
| `JWT_TOKEN` | *(√† d√©finir apr√®s login)* | Token d'authentification |
| `DOWNLOAD_ID` | *(g√©n√©r√© lors du t√©l√©chargement)* | ID du t√©l√©chargement en cours |
| `PREPROMPT_ID` | *(r√©cup√©r√© lors de la cr√©ation)* | ID d'un preprompt cr√©√© |

## üîç Tests de base

### 1. Sant√© du serveur ‚úÖ
```http
GET {{BASE_URL}}/health
```
**Attendu :** Status 200, r√©ponse avec `status: "healthy"`

### 2. Informations API ‚úÖ
```http
GET {{BASE_URL}}/api
```
**Attendu :** Status 200, liste compl√®te des endpoints

---

## üîê Tests d'authentification

### 3. Inscription utilisateur ‚úÖ
```http
POST {{BASE_URL}}/api/auth/register
Content-Type: application/json

{
  "email": "test@example.com",
  "username": "testuser",
  "password": "password123"
}
```
**Attendu :** Status 201, token JWT + infos utilisateur

### 4. Connexion utilisateur ‚úÖ
```http
POST {{BASE_URL}}/api/auth/login
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "password123"
}
```
**Attendu :** Status 200, token JWT + infos utilisateur
**Action :** Copier le token dans `JWT_TOKEN`

### 5. Profil utilisateur ‚úÖ
```http
GET {{BASE_URL}}/api/auth/me
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, infos utilisateur sans mot de passe

### 6. D√©connexion ‚úÖ
```http
POST {{BASE_URL}}/api/auth/logout
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, message de succ√®s

### 7. Erreur - Email d√©j√† utilis√© ‚ùå
```http
POST {{BASE_URL}}/api/auth/register
Content-Type: application/json

{
  "email": "test@example.com",
  "username": "testuser2",
  "password": "password123"
}
```
**Attendu :** Status 409, erreur "User Already Exists"

### 8. Erreur - Mauvais mot de passe ‚ùå
```http
POST {{BASE_URL}}/api/auth/login
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "wrongpassword"
}
```
**Attendu :** Status 401, erreur "Invalid Credentials"

### 9. Erreur - Token invalide ‚ùå
```http
GET {{BASE_URL}}/api/auth/me
Authorization: Bearer invalid_token_here
```
**Attendu :** Status 401, erreur "Invalid token"

### 10. Erreur - Validation donn√©es ‚ùå
```http
POST {{BASE_URL}}/api/auth/register
Content-Type: application/json

{
  "email": "invalid-email",
  "username": "ab",
  "password": "123"
}
```
**Attendu :** Status 400, erreurs de validation d√©taill√©es

---

## üí¨ Tests de chat

### 11. Statut du mod√®le ‚úÖ
```http
GET {{BASE_URL}}/api/chat/status
```
**Attendu :** Status 200, statut du mod√®le (probablement pas charg√© au d√©but)

### 12. Test connexion llama.cpp ‚úÖ
```http
POST {{BASE_URL}}/api/chat/test
```
**Attendu :** Status 200 ou 503 selon la configuration de llama.cpp

### 13. Message simple sans mod√®le ‚ö†Ô∏è
```http
POST {{BASE_URL}}/api/chat
Content-Type: application/json

{
  "message": "Bonjour, comment √ßa va ?"
}
```
**Attendu :** Probablement erreur car aucun mod√®le activ√©

### 14. Chat avec param√®tres personnalis√©s ‚úÖ
```http
POST {{BASE_URL}}/api/chat
Content-Type: application/json

{
  "message": "Raconte-moi une histoire courte",
  "modelParams": {
    "temperature": 1.2,
    "maxTokens": 500,
    "topP": 0.9,
    "repeatPenalty": 1.1
  }
}
```
**Attendu :** Status 200 (si mod√®le activ√©) ou erreur

### 15. Chat avec historique ‚úÖ
```http
POST {{BASE_URL}}/api/chat
Content-Type: application/json

{
  "message": "Et ensuite que s'est-il pass√© ?",
  "history": [
    {
      "role": "user",
      "content": "Raconte-moi une histoire",
      "timestamp": "2025-06-08T10:00:00Z"
    },
    {
      "role": "assistant", 
      "content": "Il √©tait une fois...",
      "timestamp": "2025-06-08T10:00:05Z"
    }
  ]
}
```
**Attendu :** Status 200, r√©ponse contextuelle

### 16. Arr√™ter g√©n√©ration ‚úÖ
```http
POST {{BASE_URL}}/api/chat/stop
```
**Attendu :** Status 200, g√©n√©ration arr√™t√©e

---

## ü§ñ Tests de gestion des mod√®les

### 17. Lister mod√®les ‚úÖ
```http
GET {{BASE_URL}}/api/models
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, liste (vide au d√©but)

### 18. T√©l√©charger mod√®le Phi-3 ‚úÖ
```http
POST {{BASE_URL}}/api/models/download
Authorization: Bearer {{JWT_TOKEN}}
Content-Type: application/json

{
  "url": "https://huggingface.co/microsoft/Phi-3-mini-4k-instruct-gguf/resolve/main/Phi-3-mini-4k-instruct-q4.gguf"
}
```
**Attendu :** Status 200, downloadId
**Action :** Copier le downloadId dans `DOWNLOAD_ID`
**Note :** T√©l√©chargement de ~2GB, prendra du temps

### 19. Statut t√©l√©chargements ‚úÖ
```http
GET {{BASE_URL}}/api/models/downloads
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, liste des t√©l√©chargements actifs

### 20. Statut t√©l√©chargement sp√©cifique ‚úÖ
```http
GET {{BASE_URL}}/api/models/downloads/{{DOWNLOAD_ID}}
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, progression du t√©l√©chargement

### 21. Annuler t√©l√©chargement (optionnel) ‚ö†Ô∏è
```http
POST {{BASE_URL}}/api/models/downloads/{{DOWNLOAD_ID}}/cancel
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, t√©l√©chargement annul√©

### 22. Activer mod√®le (apr√®s t√©l√©chargement) ‚úÖ
```http
POST {{BASE_URL}}/api/models/activate
Authorization: Bearer {{JWT_TOKEN}}
Content-Type: application/json

{
  "filename": "Phi-3-mini-4k-instruct-q4.gguf"
}
```
**Attendu :** Status 200, mod√®le activ√©

### 23. Nettoyer t√©l√©chargements ‚úÖ
```http
POST {{BASE_URL}}/api/models/downloads/cleanup
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, t√©l√©chargements nettoy√©s

### 24. Erreur - Supprimer mod√®le actif ‚ùå
```http
DELETE {{BASE_URL}}/api/models/Phi-3-mini-4k-instruct-q4.gguf
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 400, erreur "mod√®le actuellement utilis√©"

### 25. Erreur - URL invalide ‚ùå
```http
POST {{BASE_URL}}/api/models/download
Authorization: Bearer {{JWT_TOKEN}}
Content-Type: application/json

{
  "url": "https://invalid-url.com/model.txt"
}
```
**Attendu :** Status 400, erreur URL invalide

---

## üìù Tests de preprompts

### 26. Lister preprompts ‚úÖ
```http
GET {{BASE_URL}}/api/preprompts
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, liste avec 3 preprompts par d√©faut

### 27. Preprompt par d√©faut ‚úÖ
```http
GET {{BASE_URL}}/api/preprompts/default
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, preprompt "Assistant g√©n√©ral"

### 28. Cr√©er nouveau preprompt ‚úÖ
```http
POST {{BASE_URL}}/api/preprompts
Authorization: Bearer {{JWT_TOKEN}}
Content-Type: application/json

{
  "name": "Assistant Test",
  "content": "Tu es un assistant de test tr√®s sympa et utile.",
  "description": "Preprompt cr√©√© pour les tests automatis√©s",
  "isDefault": false
}
```
**Attendu :** Status 201, nouveau preprompt cr√©√©
**Action :** Copier l'ID dans `PREPROMPT_ID`

### 29. R√©cup√©rer preprompt sp√©cifique ‚úÖ
```http
GET {{BASE_URL}}/api/preprompts/{{PREPROMPT_ID}}
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, d√©tails du preprompt

### 30. Modifier preprompt ‚úÖ
```http
PUT {{BASE_URL}}/api/preprompts/{{PREPROMPT_ID}}
Authorization: Bearer {{JWT_TOKEN}}
Content-Type: application/json

{
  "name": "Assistant Test Modifi√©",
  "content": "Tu es un assistant de test tr√®s sympa, utile et modifi√©.",
  "description": "Preprompt modifi√© lors des tests"
}
```
**Attendu :** Status 200, preprompt modifi√©

### 31. D√©finir comme d√©faut ‚úÖ
```http
POST {{BASE_URL}}/api/preprompts/{{PREPROMPT_ID}}/set-default
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, preprompt d√©fini comme d√©faut

### 32. Chat avec preprompt sp√©cifique ‚úÖ
```http
POST {{BASE_URL}}/api/chat
Authorization: Bearer {{JWT_TOKEN}}
Content-Type: application/json

{
  "message": "Aide-moi √† r√©soudre un probl√®me de code Python",
  "prepromptId": "{{PREPROMPT_ID}}"
}
```
**Attendu :** Status 200, r√©ponse avec le contexte du preprompt

### 33. Erreur - Preprompt inexistant ‚ùå
```http
GET {{BASE_URL}}/api/preprompts/nonexistent-id
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 404, erreur "Preprompt not found"

### 34. Erreur - Nom d√©j√† utilis√© ‚ùå
```http
POST {{BASE_URL}}/api/preprompts
Authorization: Bearer {{JWT_TOKEN}}
Content-Type: application/json

{
  "name": "Assistant g√©n√©ral",
  "content": "Contenu test",
  "description": "Test de duplication"
}
```
**Attendu :** Status 400, erreur nom d√©j√† utilis√©

---

## üí¨ Tests de chat avanc√©s (avec mod√®le)

### 35. Chat simple avec mod√®le ‚úÖ
```http
POST {{BASE_URL}}/api/chat
Content-Type: application/json

{
  "message": "Salut ! Comment √ßa va ?"
}
```
**Attendu :** Status 200, r√©ponse du mod√®le Phi-3

### 36. Chat avec utilisateur authentifi√© ‚úÖ
```http
POST {{BASE_URL}}/api/chat
Authorization: Bearer {{JWT_TOKEN}}
Content-Type: application/json

{
  "message": "Explique-moi les bases de l'intelligence artificielle"
}
```
**Attendu :** Status 200, r√©ponse sauvegard√©e dans l'historique

### 37. Chat avec tous les param√®tres ‚úÖ
```http
POST {{BASE_URL}}/api/chat
Authorization: Bearer {{JWT_TOKEN}}
Content-Type: application/json

{
  "message": "√âcris un po√®me sur la technologie",
  "prepromptId": "{{PREPROMPT_ID}}",
  "modelParams": {
    "temperature": 1.1,
    "maxTokens": 300,
    "topP": 0.95,
    "repeatPenalty": 1.2,
    "contextSize": 2048,
    "seed": 42
  },
  "history": [
    {
      "role": "user",
      "content": "J'aime la po√©sie",
      "timestamp": "2025-06-08T10:00:00Z"
    }
  ]
}
```
**Attendu :** Status 200, po√®me cr√©atif

---

## üßπ Tests de nettoyage

### 38. Supprimer preprompt de test ‚úÖ
```http
DELETE {{BASE_URL}}/api/preprompts/{{PREPROMPT_ID}}
Authorization: Bearer {{JWT_TOKEN}}
```
**Attendu :** Status 200, preprompt supprim√©

### 39. V√©rification finale ‚úÖ
```http
GET {{BASE_URL}}/api
```
**Attendu :** Status 200, API toujours fonctionnelle

---

## üìä R√©sultats attendus

### ‚úÖ Succ√®s complet
- **39/39 tests passent** : Backend parfaitement fonctionnel
- Toutes les fonctionnalit√©s op√©rationnelles
- Pr√™t pour la production

### ‚ö†Ô∏è Succ√®s partiel
- **Tests auth (3-10) passent** : Authentification OK
- **Tests preprompts (26-34) passent** : Gestion preprompts OK
- **Tests chat √©chouent** : Probl√®me avec llama.cpp ou mod√®les

### ‚ùå √âchecs critiques
- **Tests de base (1-2) √©chouent** : Serveur non d√©marr√©
- **Tests auth √©chouent** : Probl√®me de base de donn√©es
- **Erreurs 500** : Configuration incorrecte

## üîß Actions selon les r√©sultats

### Si tests llama.cpp √©chouent (12, 35-37)
1. V√©rifier `LLAMA_CPP_PATH` dans `.env`
2. Tester manuellement : `/path/to/llama.cpp/main --help`
3. Recompiler llama.cpp si n√©cessaire

### Si t√©l√©chargement √©choue (18-22)
1. V√©rifier la connexion internet
2. Tester curl manuellement
3. V√©rifier l'espace disque disponible

### Si authentification √©choue (3-10)
1. V√©rifier `JWT_SECRET` dans `.env`
2. R√©initialiser la base de donn√©es
3. Supprimer `database.sqlite` et red√©marrer

### Si preprompts √©chouent (26-34)
1. V√©rifier les permissions du dossier `data/`
2. Supprimer `data/preprompts.json` pour r√©initialiser

## üìù Script de test automatique

Vous pouvez √©galement utiliser ce script bash pour tester rapidement :

```bash
#!/bin/bash
# test-api.sh

BASE_URL="http://localhost:3000"
JWT_TOKEN=""

echo "üß™ Tests automatiques du backend Phi-3"
echo "====================================="

# Test 1: Sant√© du serveur
echo "1. Test sant√© du serveur..."
curl -s "${BASE_URL}/health" | jq -r '.status // "FAILED"'

# Test 2: Inscription
echo "2. Test inscription..."
REGISTER_RESPONSE=$(curl -s -X POST "${BASE_URL}/api/auth/register" \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","username":"testuser","password":"password123"}')

if echo "$REGISTER_RESPONSE" | jq -e '.success' >/dev/null; then
  JWT_TOKEN=$(echo "$REGISTER_RESPONSE" | jq -r '.data.token')
  echo "‚úÖ Inscription r√©ussie"
else
  echo "‚ùå Inscription √©chou√©e"
  echo "$REGISTER_RESPONSE" | jq -r '.message // .error'
fi

# Test 3: Profil utilisateur
if [ ! -z "$JWT_TOKEN" ]; then
  echo "3. Test profil utilisateur..."
  PROFILE_RESPONSE=$(curl -s "${BASE_URL}/api/auth/me" \
    -H "Authorization: Bearer $JWT_TOKEN")
  
  if echo "$PROFILE_RESPONSE" | jq -e '.success' >/dev/null; then
    echo "‚úÖ Profil r√©cup√©r√©"
  else
    echo "‚ùå Profil √©chou√©"
  fi
fi

# Test 4: Liste des mod√®les
if [ ! -z "$JWT_TOKEN" ]; then
  echo "4. Test liste des mod√®les..."
  MODELS_RESPONSE=$(curl -s "${BASE_URL}/api/models" \
    -H "Authorization: Bearer $JWT_TOKEN")
  
  if echo "$MODELS_RESPONSE" | jq -e '.success' >/dev/null; then
    MODEL_COUNT=$(echo "$MODELS_RESPONSE" | jq -r '.data.count')
    echo "‚úÖ Mod√®les list√©s: $MODEL_COUNT mod√®les"
  else
    echo "‚ùå Liste mod√®les √©chou√©e"
  fi
fi

# Test 5: Liste des preprompts
if [ ! -z "$JWT_TOKEN" ]; then
  echo "5. Test liste des preprompts..."
  PREPROMPTS_RESPONSE=$(curl -s "${BASE_URL}/api/preprompts" \
    -H "Authorization: Bearer $JWT_TOKEN")
  
  if echo "$PREPROMPTS_RESPONSE" | jq -e '.success' >/dev/null; then
    PREPROMPT_COUNT=$(echo "$PREPROMPTS_RESPONSE" | jq -r '.data.count')
    echo "‚úÖ Preprompts list√©s: $PREPROMPT_COUNT preprompts"
  else
    echo "‚ùå Liste preprompts √©chou√©e"
  fi
fi

# Test 6: Test connexion llama.cpp
echo "6. Test connexion llama.cpp..."
LLAMA_RESPONSE=$(curl -s -X POST "${BASE_URL}/api/chat/test")
CONNECTION_STATUS=$(echo "$LLAMA_RESPONSE" | jq -r '.data.connectionStatus // "UNKNOWN"')

if [ "$CONNECTION_STATUS" = "OK" ]; then
  echo "‚úÖ llama.cpp connect√©"
else
  echo "‚ö†Ô∏è  llama.cpp non connect√© ($CONNECTION_STATUS)"
fi

echo ""
echo "üèÅ Tests termin√©s!"
echo "Pour des tests complets, utilisez Hoppscotch avec la collection fournie."
```

## üìÑ Rapport de test

Apr√®s avoir ex√©cut√© tous les tests, documentez vos r√©sultats :

### Environnement de test
- **OS :** 
- **Node.js :** 
- **Backend version :** 
- **llama.cpp :** Disponible ‚úÖ/‚ùå

### R√©sultats par cat√©gorie
- **Tests de base (1-2) :** ‚úÖ/‚ùå
- **Tests auth (3-10) :** ‚úÖ/‚ùå 
- **Tests chat (11-16) :** ‚úÖ/‚ùå
- **Tests mod√®les (17-25) :** ‚úÖ/‚ùå
- **Tests preprompts (26-34) :** ‚úÖ/‚ùå
- **Tests avanc√©s (35-37) :** ‚úÖ/‚ùå

### Notes
- Temps de r√©ponse moyen : 
- Probl√®mes rencontr√©s :
- Configuration sp√©ciale :

### Recommandations
- [ ] Pr√™t pour la production
- [ ] N√©cessite des corrections
- [ ] Configuration llama.cpp requise

---

Cette collection de tests vous assure un backend robuste et fiable ! üöÄ